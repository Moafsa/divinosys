<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exemplo - Interface de Desconto no Fechamento de Mesa</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { padding: 8px; width: 200px; border: 1px solid #ddd; border-radius: 4px; }
        .discount-section { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .total-display { font-size: 18px; font-weight: bold; color: #28a745; margin-top: 10px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h2>Fechamento de Mesa/Pedido</h2>

    <form id="fecharMesaForm">
        <div class="form-group">
            <label for="forma_pagamento">Forma de Pagamento:</label>
            <select id="forma_pagamento" name="forma_pagamento" required>
                <option value="">Selecione...</option>
                <option value="dinheiro">Dinheiro</option>
                <option value="cartao_credito">Cartão de Crédito</option>
                <option value="cartao_debito">Cartão de Débito</option>
                <option value="pix">PIX</option>
                <option value="vale_refeicao">Vale Refeição</option>
            </select>
        </div>

        <div class="form-group">
            <label for="numero_pessoas">Número de Pessoas:</label>
            <input type="number" id="numero_pessoas" name="numero_pessoas" min="1" value="1" required>
        </div>

        <div class="form-group">
            <label for="observacao">Observação:</label>
            <input type="text" id="observacao" name="observacao" placeholder="Observações sobre o pagamento">
        </div>

        <!-- Seção de Desconto -->
        <div class="discount-section">
            <h3>Desconto (Opcional)</h3>

            <div class="form-group">
                <label for="aplicar_desconto">
                    <input type="checkbox" id="aplicar_desconto" name="aplicar_desconto">
                    Aplicar desconto
                </label>
            </div>

            <div id="desconto_fields" style="display: none;">
                <div class="form-group">
                    <label for="tipo_desconto">Tipo de Desconto:</label>
                    <select id="tipo_desconto" name="tipo_desconto">
                        <option value="valor_fixo">Valor Fixo (R$)</option>
                        <option value="percentual">Percentual (%)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="valor_desconto">Valor do Desconto:</label>
                    <input type="number" id="valor_desconto" name="valor_desconto" min="0" step="0.01" placeholder="0.00">
                </div>
            </div>
        </div>

        <div class="total-display">
            Valor Total: R$ <span id="valor_total">0.00</span>
        </div>

        <div class="total-display" id="valor_com_desconto" style="display: none;">
            Valor com Desconto: R$ <span id="valor_final">0.00</span>
        </div>

        <br>
        <button type="submit">Fechar Mesa e Registrar Pagamento</button>
    </form>

    <script>
        // Exemplo de dados - em produção, viria do backend
        const valorTotalPedido = 150.00; // Este valor viria do backend
        let valorDescontoAplicado = 0;

        // Elementos DOM
        const aplicarDescontoCheckbox = document.getElementById('aplicar_desconto');
        const descontoFields = document.getElementById('desconto_fields');
        const tipoDescontoSelect = document.getElementById('tipo_desconto');
        const valorDescontoInput = document.getElementById('valor_desconto');
        const valorTotalSpan = document.getElementById('valor_total');
        const valorComDescontoDiv = document.getElementById('valor_com_desconto');
        const valorFinalSpan = document.getElementById('valor_final');
        const form = document.getElementById('fecharMesaForm');

        // Inicializar valores
        valorTotalSpan.textContent = valorTotalPedido.toFixed(2);

        // Event listeners
        aplicarDescontoCheckbox.addEventListener('change', function() {
            descontoFields.style.display = this.checked ? 'block' : 'none';
            if (!this.checked) {
                valorDescontoInput.value = '';
                calcularDesconto();
            }
        });

        tipoDescontoSelect.addEventListener('change', calcularDesconto);
        valorDescontoInput.addEventListener('input', calcularDesconto);

        function calcularDesconto() {
            if (!aplicarDescontoCheckbox.checked) {
                valorDescontoAplicado = 0;
                valorComDescontoDiv.style.display = 'none';
                return;
            }

            const tipoDesconto = tipoDescontoSelect.value;
            const valorDesconto = parseFloat(valorDescontoInput.value) || 0;

            if (tipoDesconto === 'percentual') {
                valorDescontoAplicado = valorTotalPedido * (valorDesconto / 100);
            } else {
                valorDescontoAplicado = valorDesconto;
            }

            // Limitar desconto ao valor total
            if (valorDescontoAplicado > valorTotalPedido) {
                valorDescontoAplicado = valorTotalPedido;
                valorDescontoInput.value = tipoDesconto === 'percentual' ? '100' : valorTotalPedido.toFixed(2);
            }

            const valorFinal = valorTotalPedido - valorDescontoAplicado;

            valorFinalSpan.textContent = valorFinal.toFixed(2);
            valorComDescontoDiv.style.display = valorDescontoAplicado > 0 ? 'block' : 'none';
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(form);

            // Adicionar os parâmetros de desconto
            if (aplicarDescontoCheckbox.checked) {
                formData.append('valor_desconto', valorDescontoAplicado.toFixed(2));
                formData.append('tipo_desconto', tipoDescontoSelect.value);
            } else {
                formData.append('valor_desconto', '0');
                formData.append('tipo_desconto', 'valor_fixo');
            }

            // Adicionar action (exemplo para fechamento de mesa)
            formData.append('action', 'fechar_mesa_completa');
            formData.append('mesa_id', '1'); // Exemplo - viria do contexto

            try {
                const response = await fetch('mvc/ajax/mesa_pedidos.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso!',
                        text: 'Mesa fechada e pagamento registrado com sucesso!',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        // Redirecionar ou atualizar interface
                        window.location.reload();
                    });
                } else {
                    throw new Error(data.message || 'Erro ao processar pagamento');
                }

            } catch (error) {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: error.message || 'Erro ao processar o fechamento da mesa'
                });
            }
        });

        // Inicializar cálculo
        calcularDesconto();
    </script>
</body>
</html>